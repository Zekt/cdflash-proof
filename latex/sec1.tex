% !TEX root = main.tex

\section{Overall Structure}

%Recall that, to simplify the proof of crash-determinacy, we introduce an abstract (and simpler) transition system~\Spec\ that acts as a specification of the actual program transition system~\Prog.
%Crash-determinacy will be established on~\Spec\ instead, and by making \Spec\ simulate~\Prog\ (a notion which we will define below), every well-formed fragment in~\Prog\ will correspond to one in~\Spec\ and be crash-deterministic.%
%\todo{define crash-determinacy on fragments, and then on transition systems}\
%The overall strategy for carrying out the proof is to use an SMT solver wherever possible, and verify the rest with a proof assistant, in this case Agda.
%More specifically, the solver establishes the preservation of invariants in~\Prog\ and the simulation of~\Prog\ by~\Spec, and then with Agda we prove that \Spec\ is crash-deterministic, and that crash-determinacy of~\Spec\ does lead to crash-determinacy of~\Prog\ due to the simulation.

In this appendix we present the content of \S4 in detail; the content is formalized with the Agda theorem prover, but is presented here in the usual mathematical style.
The Agda proof does not depend on the detail of~\Prog\ and the invariants on program states, which will be formulated as assumptions in \cref{sec:Prog}.
We will then define \Spec\ and prove its snapshot consistency in \cref{sec:Spec}.
Next we will formally define the simulation relation between \Prog~and~\Spec, but instead of considering the entire~\Prog, it suffices to focus on a sub-system~\ProgInv\ of~\Prog\ which consists of only the states satisfying the invariants and the transitions ``respecting'' the invariants; in \cref{sec:ProgInv} we will define~\ProgInv\ and prove some of its properties.
The simulation relation between \ProgInv~and~\Spec, to be defined in \cref{sec:sim}, will be easier to handle (compared to the one between \Prog~and~\Spec), and the snapshot consistency of \ProgInv\ is the same as that of \Prog\ since the property is only about multi-recovery fragments, which can be shown (in \cref{sec:ProgInv}) to be included in~\ProgInv.
The proof of the behavioral correctness and snapshot consistency of~\ProgInv\ will then be presented in \cref{sec:proof}.

Throughout this appendix we will annotate definitions, theorems, etc with the corresponding Agda identifiers enclosed in \AgdaId{\cdot}, so that readers who are proficient in Agda can look up the identifiers in the source code easily.
